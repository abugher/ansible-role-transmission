---
install_packages:
  - 'transmission-daemon'
  - 'transmission-cli'
  - 'openvpn'
  - 'iptables'
disable_services:        
  - 'transmission-daemon'
template_files:
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                "{{ role_path }}/templates/sites-available.transmission.ssl.j2"
    dest:               '/etc/nginx/sites-available/transmission.ssl'
create_files:
  - owner:              'debian-transmission'
    group:              'debian-transmission'
    mode:               '0755'
    state:              'directory'
    path:               '/storage/bittorrent'
  - owner:              'debian-transmission'
    group:              'debian-transmission'
    mode:               '0755'
    state:              'directory'
    path:               '/storage/bittorrent/content'
  - owner:              'debian-transmission'
    group:              'debian-transmission'
    mode:               '0755'
    state:              'directory'
    path:               '/storage/bittorrent/incomplete'
  - owner:              'debian-transmission'
    group:              'debian-transmission'
    mode:               '0755'
    state:              'directory'
    path:               '/storage/bittorrent/torrents'
  - owner:              'root'
    group:              'root'
    mode:               '0755'
    state:              'directory'
    path:               '/etc/openvpn/nordvpn'
  - owner:              'debian-transmission'
    group:              'debian-transmission'
    mode:               '0644'
    state:              'touch'
    path:               '/var/log/update_transmission_blocklist.ret'
  - owner:              'debian-transmission'
    group:              'debian-transmission'
    mode:               '0644'
    state:              'touch'
    path:               '/var/log/update_transmission_blocklist.log'
install_files:
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                "{{ role_path }}/files/conf/sites-available.transmission"
    dest:               "/etc/nginx/sites-available/transmission"
  - mode:               '0644'
    owner:              'root'
    group:              'root'
    src:                '../../../sensitive-ansible/roles/transmission/files/cron.d/update_transmission_blocklist'
    dest:               '/etc/cron.d/update_transmission_blocklist'
  - mode:               '0755'
    owner:              'root'
    group:              'root'
    src:                '../../../sensitive-ansible/roles/transmission/files/bin/update_transmission_blocklist_now'
    dest:               '/usr/local/bin/update_transmission_blocklist_now'
  - mode:               '0755'
    owner:              'root'
    group:              'root'
    src:                '../../../sensitive-ansible/roles/transmission/files/bin/update_transmission_blocklist_cronjob'
    dest:               '/usr/local/bin/update_transmission_blocklist_cronjob'
  - mode:               '0600'
    owner:              'root'
    group:              'root'
    src:                '../../../sensitive-ansible/roles/transmission/files/conf/nordvpn_up'
    dest:               '/storage/nordvpn_up'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                'files/cron.d/enforce_vpn_usage'
    dest:               '/etc/cron.d/enforce_vpn_usage'
  - owner:              'root'
    group:              'root'
    mode:               '0755'
    src:                'files/bin/enforce_vpn_usage'
    dest:               '/usr/local/bin/enforce_vpn_usage'
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                'files/conf/dark.css'
    dest:               '/usr/share/transmission/web/style/transmission/dark.css'
install_files_ignore_result:
  - owner:              'debian-transmission'
    group:              'debian-transmission'
    mode:               '0600'
    src:                '../../../sensitive-ansible/roles/transmission/files/conf/settings.json'
    dest:               '/etc/transmission-daemon/settings.json'
lines_in_files:
  - dest:               '/etc/default/openvpn'
    regexp:             '^OPTARGS='
    line:               'OPTARGS='
  - dest:               '/etc/default/openvpn'
    regexp:             '^AUTOSTART='
    line:               'AUTOSTART="nordvpn"'
symlinks:
  - owner:              'root'
    group:              'root'
    src:                "/etc/nginx/sites-available/transmission"
    dest:               "/etc/nginx/sites-enabled/transmission"
  - owner:              'root'
    group:              'root'
    src:                "/etc/nginx/sites-available/transmission.ssl"
    dest:               "/etc/nginx/sites-enabled/transmission.ssl"
sync_dirs:
  - src:                '../../../sensitive-ansible/roles/transmission/files/conf/ovpn_tcp/'
    dest:               '/etc/openvpn/nordvpn/ovpn_tcp/'
    delete:             'yes'
  - src:                '../../../sensitive-ansible/roles/transmission/files/conf/ovpn_udp/'
    dest:               '/etc/openvpn/nordvpn/ovpn_udp/'
    delete:             'yes'
remove_files:
  - '/etc/openvpn/nordvpn.conf'
shell_commands:
  - command:            sed 's#^auth-user-pass.*$#auth-user-pass /storage/nordvpn_up#' /etc/openvpn/nordvpn/ovpn_udp/{{ vpn_server }}.udp.ovpn > /etc/openvpn/nordvpn.conf
    user:               'root'
    chdir:              '/'
    creates:            '/etc/openvpn/nordvpn.conf'
restart_services:
  - 'openvpn'
  - 'transmission-daemon'
